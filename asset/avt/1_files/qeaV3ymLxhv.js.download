;/*FB_PKG_DELIM*/

__d("FtsFetchEbMessagesEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6752");b=d("FalcoLoggerInternal").create("fts_fetch_eb_messages_end",a);e=b;g["default"]=e}),98);
__d("FtsFetchEbMessagesPageEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6753");b=d("FalcoLoggerInternal").create("fts_fetch_eb_messages_page_end",a);e=b;g["default"]=e}),98);
__d("FtsFetchEbMessagesPageStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6754");b=d("FalcoLoggerInternal").create("fts_fetch_eb_messages_page_start",a);e=b;g["default"]=e}),98);
__d("FtsFetchEbMessagesStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6755");b=d("FalcoLoggerInternal").create("fts_fetch_eb_messages_start",a);e=b;g["default"]=e}),98);
__d("FtsFetchOccamThreadsEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6776");b=d("FalcoLoggerInternal").create("fts_fetch_occam_threads_end",a);e=b;g["default"]=e}),98);
__d("FtsFetchOccamThreadsPageEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6777");b=d("FalcoLoggerInternal").create("fts_fetch_occam_threads_page_end",a);e=b;g["default"]=e}),98);
__d("FtsFetchOccamThreadsPageStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6778");b=d("FalcoLoggerInternal").create("fts_fetch_occam_threads_page_start",a);e=b;g["default"]=e}),98);
__d("FtsFetchOccamThreadsStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6779");b=d("FalcoLoggerInternal").create("fts_fetch_occam_threads_start",a);e=b;g["default"]=e}),98);
__d("LSIssueFetchAndIndexMessageRangeTask",["LSArrayGetObjectAt","LSBase64Encode.nop","LSIsEncryptionVersionSecure","LSIssueNewTask","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure] Beginning execution."),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[13]=new c.Map(),d[13].set("error_msg","Expected a nonempty query result"),d[13].set("code",c.i64.cast([0,3])),d[13].set("src_line","MEBClientStateUtils.php:247 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[14]=c.createArray(),d[15]=(d[14].push(d[13]),d[14]),e=[void 0,d[14]],d[1]=e[0],d[2]=e[1],e):(b=a.item,d[13]=new c.Map(),d[13].set("backup_id",b.backupId),d[13].set("device_public_key_blob",b.devicePublicKeyBlob),d[13].set("device_private_key_blob",b.devicePrivateKeyBlob),d[13].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[13].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[13].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[13].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[13].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[13].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[13].set("orf_client_state_v2_blob",void 0),d[13].set("orf_v2_authority_level",void 0),d[13].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[13].set("device_id",b.deviceId),d[13].set("backup_tenancy",b.backupTenancy),d[13].set("encryption_version",b.encryptionVersion),d[13].set("revision_version",b.revisionVersion),d[13].set("initialize_restore_result",void 0),d[13].set("device_creation_timestamp_sec",void 0),d[13].set("authority_level",b.authorityLevel),e=[d[13],void 0],d[1]=e[0],d[2]=e[1],e)})},function(e){return d[4]=new c.Map(),d[4].set("value",d[1]),d[4].set("errors",d[2]),d[5]=d[4].get("value"),d[5]!==void 0?c.sequence([function(e){return d[13]=d[5].get("backup_id"),d[14]=d[5].get("device_public_key_blob"),d[15]=d[5].get("device_private_key_blob"),d[16]=d[5].get("epoch_storage_public_key_blob"),d[17]=d[5].get("epoch_storage_private_key_blob"),d[18]=d[5].get("epoch_auth_public_key_blob"),d[19]=d[5].get("epoch_auth_private_key_blob"),d[20]=d[5].get("mailbox_root_key_blob"),d[21]=d[5].get("ocmf_client_state_blob"),d[22]=d[5].get("orf_client_state_v2_blob"),d[23]=d[5].get("orf_v2_authority_level"),d[24]=d[5].get("oblivious_validation_token_blob"),d[25]=d[5].get("device_id"),d[26]=d[5].get("backup_tenancy"),d[27]=d[5].get("encryption_version"),d[28]=d[5].get("revision_version"),d[29]=d[5].get("initialize_restore_result"),d[30]=d[5].get("device_creation_timestamp_sec"),d[31]=d[5].get("authority_level"),c.i64.neq(d[25],void 0)?c.sequence([function(a){return d[33]=void 0,c.i64.neq(d[33],void 0)?c.resolve(d[34]=d[33]):c.sequence([function(a){return d[53]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[54]=a[0],a})},function(a){return d[54]?d[63]=(d[53].push(c.i64.cast([0,0])),d[53]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[55]=a[0],a})},function(a){return d[55]?d[63]=(d[53].push(c.i64.cast([0,2])),d[53]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[56]=a[0],a})},function(a){return d[56]?d[63]=(d[53].push(c.i64.cast([0,3])),d[53]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[57]=a[0],a})},function(a){return d[57]?d[63]=(d[53].push(c.i64.cast([0,4])),d[53]):0,d[58]=c.createArray(),d[59]=c.i64.of_int32(d[53].length),c.i64.gt(d[59],c.i64.cast([0,0]))?c.loopAsync(d[59],function(a){return d[63]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[53],d[63]).then(function(a){return a=a,d[64]=a[0],d[65]=a[1],a})},function(a){return d[66]=(d[58].push(d[64]),d[58])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[63]=c.createArray(),d[64]=c.i64.of_int32(d[58].length),c.i64.gt(d[64],c.i64.cast([0,0]))?c.loopAsync(d[64],function(a){return d[66]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[58],d[66]).then(function(a){return a=a,d[67]=a[0],d[68]=a[1],a})},function(a){return d[69]=(d[63].push(c.i64.to_string(d[67])),d[63])}])}):c.resolve()},function(a){return d[65]=d[63].join(","),d[60]=d[65]}])},function(a){return d[58].some(function(a){return c.i64.eq(d[27],a)})?d[61]=d[27]:d[61]=void 0,c.i64.neq(d[61],void 0)?d[62]=d[61]:d[62]=void 0,d[34]=d[62]}])},function(a){return c.i64.neq(d[34],void 0)?d[35]=d[34]:d[35]=c.i64.cast([0,0]),c.i64.neq(d[26],void 0)?d[36]=d[26]:d[36]=c.i64.cast([0,1]),c.i64.eq(d[36],c.i64.cast([0,3]))?d[37]=c.i64.cast([0,4]):d[37]=c.i64.cast([0,0]),c.nativeOperation(b("LSBase64Encode.nop"),d[21]).then(function(a){return a=a,d[38]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[20]).then(function(a){return a=a,d[39]=a[0],a})},function(a){return d[40]=new c.Map(),d[40].set("ocmf_client_state_blob",d[38]==null?"":d[38]),d[40].set("mailbox_root_key",d[39]==null?"":d[39]),d[41]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[53]=(d[41].push(a.epochId),d[41])})},function(a){return d[51]="Queried locally available epochs. Count: ",d[42]=c.i64.of_int32(d[41].length),d[52]=c.i64.to_string(d[42]),d[43]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][MEBEpochClientUtils] ",d[43],d[51],d[43],d[52]].join("")),c.resolve()},function(e){return d[44]=new c.Map(),d[44].set("device_id",d[25]),d[44].set("raw_tokens",d[40]),d[44].set("locally_available_epochs",d[41]),d[45]=new c.Map(),d[45].set("act_thread_id",a[0]),d[45].set("request_id",a[3]),d[45].set("tam_thread_subtype",d[37]),d[45].set("source",c.i64.cast([0,43])),d[46]=new c.Map(),d[46].set("reference_timestamp",a[2]),d[46].set("direction",c.i64.cast([0,1])),d[46].set("server_thread_key",void 0),d[46].set("device_context",d[44]),d[46].set("source",c.i64.cast([0,43])),d[47]=new c.Map(),d[47].set("restore_context",d[45]),d[47].set("success",d[46]),d[48]=d[47].get("queue_name"),d[48]!==void 0?d[49]=d[48]:(d[53]=d[47].get("restore_context"),d[54]=d[53].get("act_thread_id"),d[49]=["encrypted_backups_restore",":",d[54]].join("")),d[50]=c.toJSON(d[47]),c.storedProcedure(b("LSIssueNewTask"),d[49],c.i64.cast([0,50030]),d[50],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]))},function(a){return d[32]=!0}]):c.sequence([function(e){return d[33]=new c.Map(),d[33].set("error_code",c.i64.cast([0,1])),d[33].set("error_message",void 0==null?"":void 0),d[33].set("stored_procedure","issueFetchAndIndexMessageRangeTask"),d[34]=new c.Map(),d[34].set("act_thread_id",a[0]),d[34].set("source",c.i64.cast([0,43])),d[34].set("restore_operation_type",c.i64.cast([0,2])),d[34].set("request_id",void 0),d[34].set("device_id",void 0),d[35]=new c.Map(),d[35].set("restore_context",d[34]),d[35].set("failure",d[33]),d[36]=d[35].get("queue_name"),d[36]!==void 0?d[37]=d[36]:(d[40]=d[35].get("restore_context"),d[41]=d[40].get("act_thread_id"),d[37]=["encrypted_backups_restore",":",d[41]].join("")),d[38]=c.toJSON(d[35]),c.storedProcedure(b("LSIssueNewTask"),d[37],c.i64.cast([0,50030]),d[38],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]))},function(a){return d[39]="backup not found",d[39]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure] ","",d[39]].join("")),d[40]=c.createArray(),void 0!==void 0?d[41]=(d[40].push(void 0),d[40]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure",d[39],d[40],c.i64.cast([0,3]))):c.resolve()},function(a){return d[32]=!1}])},function(a){return d[6]=d[32]}]):c.sequence([function(e){return d[13]=d[4].get("errors"),d[14]=d[4].get("errors"),d[15]=new c.Map(),d[15].set("error_code",c.i64.cast([0,1])),d[15].set("error_message",void 0==null?"":void 0),d[15].set("stored_procedure","issueFetchAndIndexMessageRangeTask"),d[16]=new c.Map(),d[16].set("act_thread_id",a[0]),d[16].set("source",c.i64.cast([0,43])),d[16].set("restore_operation_type",c.i64.cast([0,2])),d[16].set("request_id",void 0),d[16].set("device_id",void 0),d[17]=new c.Map(),d[17].set("restore_context",d[16]),d[17].set("failure",d[15]),d[18]=d[17].get("queue_name"),d[18]!==void 0?d[19]=d[18]:(d[22]=d[17].get("restore_context"),d[23]=d[22].get("act_thread_id"),d[19]=["encrypted_backups_restore",":",d[23]].join("")),d[20]=c.toJSON(d[17]),c.storedProcedure(b("LSIssueNewTask"),d[19],c.i64.cast([0,50030]),d[20],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]))},function(a){return d[21]="backup not found",d[21]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure] ","",d[21]].join("")),d[22]=c.createArray(),void 0!==void 0?d[23]=(d[22].push(void 0),d[22]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure",d[21],d[22],c.i64.cast([0,3]))):c.resolve()},function(a){return d[6]=!1}])},function(a){return d[7]=c.i64.of_float(Date.now()),d[8]=c.i64.random(),d[10]="Finishing execution. Execution time: ",d[11]=c.i64.to_string(c.i64.sub(d[7],d[0])),d[12]=" ms",d[9]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure] ",d[9],d[10],d[9],d[11],d[9],d[12]].join("")),c.i64.eq(c.i64.mod_(d[8],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[13]=",",d[14]=c.createArray(),void 0!==void 0?d[15]=(d[14].push(void 0),d[14]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure",[d[10],d[13],d[11],d[13],d[12]].join(""),d[14],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSIssueFetchAndIndexMessageRangeTaskStoredProcedure",["LSIssueFetchAndIndexMessageRangeTask","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSIssueFetchAndIndexMessageRangeTask"),e.threadId,e.numMessages,e.startSortKey,e.traceId);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MAWFTSEncryptedBackupLightweightRestore",["EBIsEbEnabled","LSFactory","LSIssueFetchAndIndexMessageRangeTaskStoredProcedure","LSMEBTaskCreationSource","MAWAsyncEBPendingQueryPromise","MAWBridgeSendAndReceive","MAWEBRestoreTrackingUtils","MAWMainTraceUtils","MAWMpsGating","MWEncryptedBackUpEBNotEnabledError","Promise","emptyFunction","err","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,e,f,g,j,k){j===void 0&&(j=c("emptyFunction"));if(!c("gkx")("23914"))return null;var l=d("MAWMainTraceUtils").createTraceId();c("promiseDone")(d("EBIsEbEnabled").isEbEnabledLS(a.tables).then(function(m){if(!m){d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(l,c("err")(d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED));return(h||(h=b("Promise"))).resolve()}return i(l,a,e,f,g,j,k)}));return l}function i(a,e,g,i,j,k,l){k===void 0&&(k=c("emptyFunction"));k();return c("gkx")("8971")||d("MAWMpsGating").isFullMpsEnabled()?d("MAWBridgeSendAndReceive").sendAndReceive("backend","issueGraphQLRangeRestoreRequest",{chatJid:l,direction:"before",sortOrderMs:i!=null?i:void 0,source:c("LSMEBTaskCreationSource").FTS_INDEX_EB_MESSAGES_WEB,threadId:g,traceId:a}).then(function(e){if(e.loadMessagesResponse!=null)d("MAWAsyncEBPendingQueryPromise").resolvePendingQueryIfPresent(a,e.loadMessagesResponse);else{d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(a,c("err")((e=e.error)!=null?e:"Error restoring from EB over graphQL in worker"))}return(h||(h=b("Promise"))).resolve()}):e.runInTransaction(function(b){d("MAWEBRestoreTrackingUtils").markEBRestoreSearch({querySource:"LS",traceId:a});return c("LSIssueFetchAndIndexMessageRangeTaskStoredProcedure")(c("LSFactory")(b),{numMessages:j,startSortKey:i==null?void 0:i,threadId:g,traceId:a})},"readwrite",void 0,void 0,f.id+":108")}g.runQuery=a}),98);
__d("MAWAsyncEBIssueFetchAndIndexFTSQuery",["MAWAsyncEBPendingQueryPromise","MAWFTSEncryptedBackupLightweightRestore","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){f===void 0&&(f=function(){});var g=d("WAJids").threadIdForChatJid(b);a=d("MAWFTSEncryptedBackupLightweightRestore").runQuery(a,g,c,e,f,b);if(a==null)return null;d("MAWAsyncEBPendingQueryPromise").setJidFromThreadId(g,b);return{promise:d("MAWAsyncEBPendingQueryPromise").getPendingQueryPromiseFromTrace(a),traceId:a}}g.issueQueryAsPromise=a}),98);
__d("MAWEncryptedBackupsUpdateGlobalRestoreStatus",["WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Thread with thread id "," is not currently being tracked, but restore seems to be in progress"]);h=function(){return a};return a}var i=new Set(),j=new Set();function k(a){if(a==="restore")return i;else return j}function a(a,b){b=k(b);b.add(a)}function b(a,b){b=k(b);b.has(a)?b["delete"](a):d("WALogger").WARN(h(),a)}function c(a){a=k(a);return a.size}g.addThreadIdToStatusArray=a;g.removeThreadIdFromStatusArray=b;g.getCurrentGlobalRestoreStatusArrayLength=c}),98);
__d("MAWFTSRestoreCap",["WATimeUtils","justknobx"],(function(a,b,c,d,e,f,g){"use strict";b=c("justknobx")._("1658");e=d("WATimeUtils").DAY_MILLISECONDS*b;var h=Date.now()-e;function a(a){return a>h}g.RESTORE_CAP_DATE_MS=h;g.isRestoreTimeWithinCap=a}),98);
__d("MAWMediaGalleryBufferAndRestore",[],(function(a,b,c,d,e,f){"use strict";var g=null,h=[],i=[],j=[],k=null,l=2e3,m=10;function a(a,b,c,d,e,f,n,o,p,q){q==null?void 0:q.addPoint("buffer_and_restore_protobuf_start");var r=function(){var g;h=h.concat(b);i=i.concat((g=c)!=null?g:[]);q!=null&&j.push(q);h.length>=m?(j.forEach(function(a){return a.addPoint("buffer_and_restore_protobuf_end",{string:{reason:"max_buffer_size"}})}),void p(a,h,i,d,e,f,n,o,j),h=[],i=[],j=[]):k=window.setTimeout(function(){var b=[].concat(h),c=[].concat(i),g=[].concat(j);g.forEach(function(a){return a.addPoint("buffer_and_restore_protobuf_end",{string:{reason:"timeout"}})});void p(a,b,c,d,e,f,n,o,g);h=[];i=[];j=[]},l)},s=function(){window.clearTimeout(k);var a=h.map(function(a){return a}),b=i.map(function(a){return a}),c=[].concat(j),l=g;l!=null&&(c.forEach(function(a){return a.addPoint("buffer_and_restore_protobuf_end",{string:{reason:"immediately"}})}),void p(l,a,b,d,e,f,n,o,c));h=[];i=[];j=[]};if(a!==g){s();g=a;r();return}if(h.length===0)r();else{h=h.concat(b);i=i.concat((r=c)!=null?r:[]);q!=null&&j.push(q);h.length>=m&&s()}}f.bufferAndRestoreProtobuf=a}),66);
__d("MAWRestoreMessagesFromEncryptedBackupsDeferred",["ExecutionEnvironment","LSDatabaseSingleton","LSVec","WAJobOrchestratorTypes","cr:10036","cr:9465","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=c("requireDeferred")("MAWRestoreMessagesFromEncryptedBackupsNOP").__setRef("MAWRestoreMessagesFromEncryptedBackupsDeferred");function a(a,e,g,k,l,m,n,o,p,q,r,s){s===void 0&&(s=d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION);return j.load().then(async function(j){var t=q!=null?Number(q):void 0;t=b("cr:9465")!=null?b("cr:9465").getMessageMetadataFromDeanonAPI(e,g.length,t):Promise.resolve();var u,v;(i||(i=c("ExecutionEnvironment"))).isInWorker&&b("cr:10036")!=null?(await b("cr:10036").init(),u=await b("cr:10036").getLSStorage()):(u=await (h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton,v=await t);return u.runInTransaction(function(b){return j.call(b,a,e,g,k,l,m,n,o,p,q,r,v,s,void 0)},"readwrite",void 0,void 0,f.id+":71").then(function(){return[c("LSVec").ofArray([]),c("LSVec").ofArray([]),!1]})})}g.call=a}),98);
__d("MWMediaRestoreStatus",["I64","LSDatabaseSingleton","MAWChatJid"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j={mediaCount:0,messageCount:0,threadId:(h||(h=d("I64"))).zero};async function a(a,b,c){var e=await (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton;e=await e.runInTransaction(function(b){return d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(b,(h||(h=d("I64"))).of_string(a))},"readwrite",void 0,void 0,f.id+":35");if(j.threadId===e)j.messageCount+=b,j.mediaCount+=c;else{j.messageCount=b;j.mediaCount=c;j.threadId=(b=e)!=null?b:(h||(h=d("I64"))).zero}}function b(){return j}g.updateRestoreStatus=a;g.getRestoreStatus=b}),98);
__d("MAWMediaGalleryRestoreSync",["CurrentUser","EchoMessage","EchoMessageMediaFieldUtils","I64","LSDatabaseSingleton","LSIntEnum","LSMEBTaskCreationSource","LSThreadMediaGalleryGroup","MAWChatJid","MAWFTSRestoreSync","MAWHandleEchoProtobufsRestoreApi","MAWJids","MAWJobDefinitions","MAWMediaGalleryBufferAndRestore","MAWMediaGalleryEBTaggingUtils","MAWMediaGalleryM2Utils","MAWRestoreMessagesFromEncryptedBackupsDeferred","MAWRestoreProtobufsFromEncryptedBackupsDeferred","MWMediaRestoreStatus","ReQL","WAJobOrchestratorTypes","WALogger","WAMsgType","justknobx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore RestoreType is none"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore Protobuf error: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore Protobuf error: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore: protobufMessages is null"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore Echo error: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore: echoMessages is null"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore: threadId is null"]);q=function(){return a};return a}async function a(a,b){var e=a.echoMessages,g=a.hasMoreAfter,j=a.hasMoreBefore,s=a.isPointQuery,t=a.protobufMessages,u=a.referenceTimestamp,v=a.requestId,w=a.restoreType,x=a.threadId;if(x==null){b==null?void 0:b.endFailure("threadId is null");d("WALogger").ERROR(q());return}b==null?void 0:b.addAnnotations({string:{restore_type:w}});b==null?void 0:b.addPoint("handle_media_restore_sync_start");var y=!d("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled();if(w==="echo"){var z;if(e==null){b==null?void 0:b.endFailure("echoMessages is null");d("WALogger").ERROR(p());return}b==null?void 0:b.addPoint("messages_decoding_and_filtering_start");a=e.filter(function(a){a=d("EchoMessage").decodeEchoMessage(a);return y?(a==null?void 0:a.contentType)===d("EchoMessage").EchoMessageContentType.MEDIA:(a==null?void 0:(a=a.mediaData)==null?void 0:a.attachmentType)===d("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT});b==null?void 0:b.addPoint("messages_decoding_and_filtering_end");a.length>0&&d("MAWMediaGalleryM2Utils").shouldSkipSyncToLSDB()&&d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!0);b==null?void 0:b.addAnnotations({int:{media_count:a.length,message_count:e.length}});b==null?void 0:b.addPoint("update_media_restore_status_start");await d("MWMediaRestoreStatus").updateRestoreStatus(x,e.length,a.length);b==null?void 0:b.addPoint("update_media_restore_status_end");b==null?void 0:b.addPoint("restore_messages_in_worker_start",{int:{echo_msg_count:(z=e==null?void 0:e.length)!=null?z:0,protobuf_msg_count:a.length}});c("promiseDone")(d("MAWRestoreMessagesFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(x),a.map(d("MAWJobDefinitions").toEncodedEchoMessage),j,void 0,g,void 0,s,v,u,c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE,c("justknobx")._("3213")?d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION).catch(function(a){b==null?void 0:b.endFailure(a),d("WALogger").ERROR(o(),a)}),function(){b==null?void 0:b.addPoint("restore_messages_in_worker_end"),d("MAWMediaGalleryM2Utils").shouldSkipSyncToLSDB()?(b==null?void 0:b.addPoint("restore_messages_update_ranges_start"),c("promiseDone")((h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton.then(async function(a){b==null?void 0:b.addPoint("update_range_get_thread_key_start");var e=await a.runInTransaction(function(a){return d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(a,(i||(i=d("I64"))).of_string(x))},"readonly",void 0,void 0,f.id+":159");b==null?void 0:b.addPoint("update_range_get_thread_key_end");if(e==null){b==null?void 0:b.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!1}});return}return Promise.all([r(a,e,c("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS),r(a,e,c("LSThreadMediaGalleryGroup").FILES_ONLY)])}).then(function(){d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!1),b==null?void 0:b.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!0}}),b==null?void 0:b.addPoint("handle_media_restore_sync_end"),b==null?void 0:b.endSuccess()}))):(b==null?void 0:b.addPoint("handle_media_restore_sync_end"),b==null?void 0:b.endSuccess())})}else if(w==="protobuf"){if(t==null){b==null?void 0:b.endFailure("protobufMessages is null");d("WALogger").ERROR(n());return}b==null?void 0:b.addPoint("get_user_jid_start");var A=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());b==null?void 0:b.addPoint("get_user_jid_end");b==null?void 0:b.addPoint("messages_decoding_and_filtering_start");z=t.filter(function(a){a=d("MAWHandleEchoProtobufsRestoreApi").decodeDecryptedMessageProtobuf(a,A,void 0,new Set(),new Set(),new Map(),new Map(),new Map(),!0);return y&&[d("WAMsgType").MSG_TYPE.IMAGE,d("WAMsgType").MSG_TYPE.VIDEO].includes(a.msgType)||a.msgType===d("WAMsgType").MSG_TYPE.DOCUMENT_FILE&&d("MAWMediaGalleryM2Utils").isFilesEBRestoreEnabled()});b==null?void 0:b.addPoint("messages_decoding_and_filtering_end");z.length>0&&d("MAWMediaGalleryM2Utils").shouldSkipSyncToLSDB()&&d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!0);b==null?void 0:b.addAnnotations({int:{media_count:z.length,message_count:t.length}});b==null?void 0:b.addPoint("update_media_restore_status_start");await d("MWMediaRestoreStatus").updateRestoreStatus(x,t.length,z.length);b==null?void 0:b.addPoint("update_media_restore_status_end");if(c("justknobx")._("3248")){a=function(a,b,e,g,j,k,l,n,o){var p;if(((p=e==null?void 0:e.length)!=null?p:0)===0&&b.length===0){o.forEach(function(a){a.addPoint("restore_messages_in_worker_skipped"),a.endSuccess()});return}o.forEach(function(a){return a.addPoint("restore_messages_in_worker_start",{int:{echo_msg_count:(a=e==null?void 0:e.length)!=null?a:0,protobuf_msg_count:b.length}})});c("promiseDone")(d("MAWRestoreProtobufsFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(a),b,g,void 0,j,void 0,k,l,n,void 0,e,(i||(i=d("I64"))).of_int32(c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE),c("justknobx")._("3213")?d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION,void 0).catch(function(a){o.forEach(function(b){return b.endFailure(a)}),d("WALogger").ERROR(m(),a)}),function(){o.forEach(function(a){return a.addPoint("restore_messages_in_worker_end")}),d("MAWMediaGalleryM2Utils").shouldSkipSyncToLSDB()?(o.forEach(function(a){return a.addPoint("restore_messages_update_ranges_start")}),c("promiseDone")((h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton.then(async function(a){o.forEach(function(a){return a.addPoint("update_range_get_thread_key_start")});var b=await a.runInTransaction(function(a){return d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(a,(i||(i=d("I64"))).of_string(x))},"readonly",void 0,void 0,f.id+":336");o.forEach(function(a){return a.addPoint("update_range_get_thread_key_end")});if(b==null){o.forEach(function(a){return a.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!1}})});return}return Promise.all([r(a,b,c("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS),r(a,b,c("LSThreadMediaGalleryGroup").FILES_ONLY)])}).then(function(){d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!1),o.forEach(function(a){return a.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!0}})}),o.forEach(function(a){return a.addPoint("handle_media_restore_sync_end")}),o.forEach(function(a){return a.endSuccess()})}))):(o.forEach(function(a){return a.addPoint("handle_media_restore_sync_end")}),o.forEach(function(a){return a.endSuccess()}))})};d("MAWMediaGalleryBufferAndRestore").bufferAndRestoreProtobuf(x,z,e,j,g,s,v,u,a,b)}else{b==null?void 0:b.addPoint("restore_messages_in_worker_start",{int:{echo_msg_count:(w=e==null?void 0:e.length)!=null?w:0,protobuf_msg_count:z.length}});c("promiseDone")(d("MAWRestoreProtobufsFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(x),z,j,void 0,g,void 0,s,v,u,void 0,e,(i||(i=d("I64"))).of_int32(c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE),c("justknobx")._("3213")?d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION,void 0).catch(function(a){b==null?void 0:b.endFailure(a),d("WALogger").ERROR(l(),a)}),function(){b==null?void 0:b.addPoint("restore_messages_in_worker_end"),d("MAWMediaGalleryM2Utils").shouldSkipSyncToLSDB()?(b==null?void 0:b.addPoint("restore_messages_update_ranges_start"),c("promiseDone")((h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton.then(async function(a){b==null?void 0:b.addPoint("update_range_get_thread_key_start");var e=await a.runInTransaction(function(a){return d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(a,(i||(i=d("I64"))).of_string(x))},"readonly",void 0,void 0,f.id+":443");b==null?void 0:b.addPoint("update_range_get_thread_key_end");if(e==null){b==null?void 0:b.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!1}});return}return Promise.all([r(a,e,c("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS),r(a,e,c("LSThreadMediaGalleryGroup").FILES_ONLY)])}).then(function(){d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!1),b==null?void 0:b.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!0}}),b==null?void 0:b.addPoint("handle_media_restore_sync_end"),b==null?void 0:b.endSuccess()}))):(b==null?void 0:b.addPoint("handle_media_restore_sync_end"),b==null?void 0:b.endSuccess())})}}else b==null?void 0:b.endFailure("RestoreType is none"),d("WALogger").ERROR(k())}function r(a,b,c){return d("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled()&&d("MAWMediaGalleryEBTaggingUtils").isMediaGalleryGroupSupportedForTaggedRestore(c)?Promise.resolve():a.runInTransaction(async function(e){var f=await d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.attachments_ranges_v2__generated).getKeyRange(b).filter(function(a){return(i||(i=d("I64"))).equal(a.mediaGroup,(j||(j=d("LSIntEnum"))).ofNumber(c))}));if(f==null||(f==null?void 0:f.hasMoreBefore)===!0)return;var g=babelHelpers.extends({},f,{hasMoreBefore:!0});return e.attachments_ranges_v2__generated.upsert([f.threadKey,f.mediaGroup,f.minTimestampMs],g)},"readwrite","ui",void 0,f.id+":511")}g.handleMediaRestoreSync=a}),98);
__d("MAWFTSRestoreSyncLogger",["FtsFetchEbMessagesEndFalcoEvent","FtsFetchEbMessagesPageEndFalcoEvent","FtsFetchEbMessagesPageStartFalcoEvent","FtsFetchEbMessagesStartFalcoEvent","FtsFetchOccamThreadsEndFalcoEvent","FtsFetchOccamThreadsPageEndFalcoEvent","FtsFetchOccamThreadsPageStartFalcoEvent","FtsFetchOccamThreadsStartFalcoEvent","MAWBridgeSendAndReceive"],(function(a,b,c,d,e,f,g){"use strict";var h=new Set(),i=new Set(),j=null,k=!1,l=0,m=0;async function a(){if(j!=null&&j!=="")return;j=await d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchGetFTSRestoreSessionId")}function b(a,b,d){if(!b||i.has(a)){i.add(a);return}h.has(a)||(h.add(a),d&&c("FtsFetchEbMessagesStartFalcoEvent").log(function(){var a;return{app_name:"",session_id:(a=j)!=null?a:""}}));c("FtsFetchEbMessagesPageStartFalcoEvent").log(function(){var a;return{app_name:"",session_id:(a=j)!=null?a:""}})}function e(a,b,d){if(i.has(a)||!h.has(a))return;c("FtsFetchEbMessagesPageEndFalcoEvent").log(function(){var a;return{app_name:"",messages_count:b.toString(),session_id:(a=j)!=null?a:""}});d||(i.add(a),c("FtsFetchEbMessagesEndFalcoEvent").log(function(){var a;return{app_name:"",duration:0,session_id:(a=j)!=null?a:"",total_messages_count:"0"}}))}function f(a){if(i.has(a)||!h.has(a))return;c("FtsFetchEbMessagesPageEndFalcoEvent").log(function(){var a;return{app_name:"",messages_count:"0",session_id:(a=j)!=null?a:""}})}function n(){c("FtsFetchOccamThreadsEndFalcoEvent").log(function(){var a;return{app_name:"",duration:0,remaining_threads_count:m.toString(),session_id:(a=j)!=null?a:"",total_threads_count:l.toString()}})}function o(){k||(k=!0,c("FtsFetchOccamThreadsStartFalcoEvent").log(function(){var a;return{app_name:"",session_id:(a=j)!=null?a:""}})),c("FtsFetchOccamThreadsPageStartFalcoEvent").log(function(){var a;return{app_name:"",session_id:(a=j)!=null?a:""}})}function p(a){c("FtsFetchOccamThreadsPageEndFalcoEvent").log(function(){var b;return{app_name:"",session_id:(b=j)!=null?b:"",thread_count:a.toString()}})}function q(a){l++,a||m++}g.initLoggingSessionId=a;g.onFetchMessagePageStart=b;g.onFetchMessagePageComplete=e;g.onFetchMessagePageFailed=f;g.onFetchThreadsComplete=n;g.onFetchThreadsPageStart=o;g.onFetchThreadsPageComplete=p;g.incrementTotalResultCount=q}),98);
__d("MWMediaRestoreQplUtils",["MAWLoggerUtils","MAWMediaGalleryM2Utils","QPLUserFlow","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h=18e4;function i(a){var b=d("MAWLoggerUtils").getInstanceKey();return{addAnnotations:function(d){c("QPLUserFlow").addAnnotations(a,d,{instanceKey:b})},addPoint:function(d,e){c("QPLUserFlow").addPoint(a,d,{data:e,instanceKey:b})},endCancel:function(d){c("QPLUserFlow").endCancel(a,{cancelReason:d,instanceKey:b})},endFailure:function(d){c("QPLUserFlow").endFailure(a,d,{instanceKey:b})},endSuccess:function(){c("QPLUserFlow").endSuccess(a,{instanceKey:b})},start:function(){c("QPLUserFlow").start(a,{instanceKey:b,timeoutInMs:h})}}}function a(){var a=d("MAWMediaGalleryM2Utils").isMediaGalleryM2Enabled(),b=c("qpl")._(25304794,"2287");return a?i(b):null}function b(){var a=c("qpl")._(25306381,"2492");return i(a)}g.createMediaRestoreBatchQPLFlow=a;g.createMediaRestoreLoadAllQPLFlow=b}),98);
__d("MAWFTSRestoreSync",["EventEmitter","FBLogger","I64","LSDatabaseSingleton","MAWAsyncEBIssueFetchAndIndexFTSQuery","MAWBridgeFireAndForget","MAWBridgeSearchMsg","MAWBridgeSendAndReceive","MAWDbMsg","MAWFTSIsMessageValidForSearch","MAWFTSRestoreCap","MAWFTSRestoreSyncLogger","MAWLoggerUtils","MAWMediaGalleryM2Utils","MAWMediaGalleryRestoreSync","MWEncryptedBackUpEBNotEnabledError","MWMediaRestoreQplUtils","QPLUserFlow","WAPromiseDelays","WAResultOrError","cr:19810","isEbEnabledWithIGDEligibilityCheck","justknobx","qpl","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=new(c("EventEmitter"))(),k=(h||(h=d("I64"))).of_int32(c("justknobx")._("2477")),l=c("justknobx")._("2606"),m=c("uuidv4")();function n(){window.setInterval(function(){d("MAWBridgeFireAndForget").fireAndForget("backend","searchFTSReportTabAlive",{hasFocus:document.hasFocus(),tabId:m},!0)},1e3)}async function o(a){await d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabTaskComplete",{error:a,tabId:m})}async function p(){await d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabDestroy",{tabId:m})}var q=function(){var e=a.prototype;e.setIsStarted=function(a){this.$1=a,this.$10==="media"&&j.emit("isSyncStarted",a)};e.setIsEBMaybeAvailable=function(a){this.$4=a,this.$10==="media"&&j.emit("isEBMaybeAvailable",a)};e.setActiveThreadId=function(a){b("cr:19810")!=null&&(a!=null&&b("cr:19810").getInstance().insertIntoHead(a)),this.$5=a,this.$10==="media"&&j.emit("activeThreadJid",a)};e.setShouldPauseRestore=function(a){this.$3=a};e.removeFromQueue=function(a){b("cr:19810")!=null&&a!=null&&b("cr:19810").getInstance().removeThread(a)};e.getActiveThreadId=function(){return this.$5};e.getNextThreadIdToFetch=function(){return b("cr:19810")!=null?b("cr:19810").getInstance().getThreadsHead():this.getActiveThreadId()};e.getDoneThreads=function(){return this.$7};e.getDoneThreadsAfterReset=function(){return this.$9};e.getResetThreads=function(){return this.$8};e.isStarted=function(){return this.$1};e.isEBMaybeAvailable=function(){return this.$4};e.resetEBAvailability=function(){this.setIsEBMaybeAvailable(!0)};e.resetRestoreStatus=function(){var a=this,b=this.getActiveThreadId();return b!=null&&!this.$8.has(b)?d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSClearThreadRestoreStatus",{threadId:b},{isLoggingDisabled:!0}).then(function(){a.$8.add(b)}):Promise.resolve()};e.registerNewMessagesListener=function(a,b){this.$6[a]=b};e.removeNewMessagesListener=function(a){delete this.$6[a]};e.$11=function(a,b){var c=this;Object.keys(this.$6).forEach(function(d){c.$6[d](a,b)})};e.$12=function(a,c,e){return a!==c&&b("cr:19810")!=null?e==null||d("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(e,10)):e!=="0"};e.$13=async function(){this.setIsStarted(!0),this.setShouldPauseRestore(!1),await d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabForeground",{tabId:m},{isLoggingDisabled:!0}),window.addEventListener("focus",async function(){await d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabForeground",{tabId:m},{isLoggingDisabled:!0})}),n()};e.startSyncingLoop=async function(){var a=this;if(this.$1||this.$4===!1)return;var e=await (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton,f=await d("isEbEnabledWithIGDEligibilityCheck").isEbEnabledWithIGDEligibilityCheck(e);if(!f){this.setIsEBMaybeAvailable(!1);this.setIsStarted(!1);return}await d("MAWFTSRestoreSyncLogger").initLoggingSessionId();await this.$13();var g=0,j=null;f=async function(){var f,i=a.getNextThreadIdToFetch(),n=a.getActiveThreadId();j!==i&&(j=i,g=0);if(i==null||b("cr:19810")==null&&a.$7.has(i)){await d("WAPromiseDelays").delayMs(200);return"continue"}if(a.$3){await d("WAPromiseDelays").delayMs(200);return"continue"}var q=await d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSGetThreadRestoreStatus",{threadId:i},{isLoggingDisabled:!0}),r=(f=q==null?void 0:q.restoredUntilSortOrderMs)!=null?f:null,s=q==null||q.restoredUntilSortOrderMs===q.maxRestoredUntilSortOrderMs||q.restoredUntilSortOrderMs==null;f=a.$12(i,n,r);if(!f){r==="0"&&(a.$7.add(i),a.$8.has(i)&&a.$9.add(i));a.removeFromQueue(i);await d("WAPromiseDelays").delayMs(200);return"continue"}q=await d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSRequestRestoreTask",{tabId:m,threadJid:i});if(!q){await d("WAPromiseDelays").delayMs(200);return"continue"}n=d("MAWAsyncEBIssueFetchAndIndexFTSQuery").issueQueryAsPromise(e,i,r,k,function(){d("MAWFTSRestoreSyncLogger").onFetchMessagePageStart(i,r==null||d("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(r,10)),s)});if(n==null){a.setIsEBMaybeAvailable(!1);a.setIsStarted(!1);return{v:Promise.resolve()}}f=d("MAWLoggerUtils").getInstanceKey();c("QPLUserFlow").start(c("qpl")._(25300854,"2397"),{annotations:{int:{retryCount:g},string:{restoreUntilMs:(q=r)!=null?q:"",traceId:n.traceId}},instanceKey:f});q=n.promise.then(function(a){return d("WAResultOrError").makeResult(a)});try{n=await Promise.race([q,new Promise(function(a){return window.setTimeout(function(){return a(d("WAResultOrError").makeError("timeout"))},l)})]);if(n.success===!1){g++;c("QPLUserFlow").endFailure(c("qpl")._(25300854,"2397"),"timeout",{instanceKey:f});d("MAWFTSRestoreSyncLogger").onFetchMessagePageFailed(i);c("FBLogger")("fts_worker").mustfix("Fail to fetch a new batch of messages due to timeout");return"continue"}g=0;c("QPLUserFlow").endSuccess(c("qpl")._(25300854,"2397"),{instanceKey:f});q=n.value;n=q.messages;q=q.nextMessageTimestampMsBefore;q=q!=null?(h||(h=d("I64"))).to_string(q):"0";var t=d("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(q,10));d("MAWFTSRestoreSyncLogger").onFetchMessagePageComplete(i,n.length,t);a.$11(i,n);t=n.map(function(a){var b=d("MAWFTSIsMessageValidForSearch").verifyMessageValidity(a);return b==null?null:d("MAWBridgeSearchMsg").createBridgeSearchMsg(babelHelpers.extends({author:a.author,canonicalTs:d("MAWDbMsg").getCanonicalTsFromMsg(a),externalId:a.externalId,threadJid:i},b),!1)}).filter(Boolean);await d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchIndexUpdate",{newSortOrderMs:q,threadId:i,unvaultedBridgeSearchMessages:t})}catch(b){if(b&&(b==null?void 0:b.message)===d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED){c("QPLUserFlow").addPoint(c("qpl")._(25300854,"2397"),"eb_not_enabled",{instanceKey:f});c("QPLUserFlow").endCancel(c("qpl")._(25300854,"2397"),{instanceKey:f});a.setIsEBMaybeAvailable(!1);a.setIsStarted(!1);await p();return{v:Promise.resolve()}}d("MAWFTSRestoreSyncLogger").onFetchMessagePageFailed(i);c("FBLogger")("fts_worker").mustfix("Fail to fetch a new batch of messages with error %s",b==null?void 0:b.message);c("QPLUserFlow").endFailure(c("qpl")._(25300854,"2397"),(n=b==null?void 0:b.message)!=null?n:"unknown",{instanceKey:f});await o(b);return"continue"}await o()};while(this.$2){var n=await f();switch(n){case"continue":continue;default:if(typeof n==="object")return n.v}}};e.startMediaSyncingLoop=async function(){if(this.$1||this.$4===!1)return;var a=await (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton,b=await d("isEbEnabledWithIGDEligibilityCheck").isEbEnabledWithIGDEligibilityCheck(a);if(!b){this.setIsEBMaybeAvailable(!1);this.setIsStarted(!1);return}await this.$13();b=0;while(this.$2){var e=this.getActiveThreadId();if(e==null||this.$7.has(e)){await d("WAPromiseDelays").delayMs(200);continue}if(this.$3){await d("WAPromiseDelays").delayMs(200);continue}var f=await d("MAWBridgeSendAndReceive").sendAndReceive("backend","getThreadMediaRestoreStatus",{threadId:e},{isLoggingDisabled:!0});f=(f=f==null?void 0:f.restoredUntilSortOrderMs)!=null?f:null;j.emit("restoredUntilMs",f!=null?parseInt(f,10):-1);var g=this.$12(e,e,f);if(!g){f==="0"&&this.$7.add(e);await d("WAPromiseDelays").delayMs(200);continue}g=await d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSRequestRestoreTask",{tabId:m,threadJid:e});if(!g){await d("WAPromiseDelays").delayMs(200);continue}g=d("MAWAsyncEBIssueFetchAndIndexFTSQuery").issueQueryAsPromise(a,e,f,k);if(g==null){this.setIsEBMaybeAvailable(!1);this.setIsStarted(!1);return Promise.resolve()}f=d("MWMediaRestoreQplUtils").createMediaRestoreBatchQPLFlow();var n=d("MAWMediaGalleryM2Utils").isMediaGalleryM2Enabled();f==null?void 0:f.start();f==null?void 0:f.addAnnotations({int:{retry_count:b}});g=g.promise.then(function(a){return d("WAResultOrError").makeResult(a)});try{f==null?void 0:f.addPoint("fetch_request_start");g=await Promise.race([g,new Promise(function(a){return window.setTimeout(function(){return a(d("WAResultOrError").makeError("timeout"))},l)})]);f==null?void 0:f.addPoint("fetch_request_end",{bool:{is_success:g.success===!0}});if(g.success===!1){b++;f==null?void 0:f.endFailure("timeout");continue}b=0;var q=g.value.nextMessageTimestampMsBefore;q=q!=null?(h||(h=d("I64"))).to_string(q):"0";n&&(f==null?void 0:f.addPoint("handle_media_restore_start"),await d("MAWMediaGalleryRestoreSync").handleMediaRestoreSync(g.value,f),f==null?void 0:f.addPoint("handle_media_restore_end"));await d("MAWBridgeSendAndReceive").sendAndReceive("backend","setThreadMediaRestoreStatus",{newSortOrderMs:q,threadId:e},{isLoggingDisabled:!0})}catch(a){if(a&&(a==null?void 0:a.message)===d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED){f==null?void 0:f.addPoint("eb_not_enabled");f==null?void 0:f.endCancel();this.setIsEBMaybeAvailable(!1);this.setIsStarted(!1);await p();return Promise.resolve()}c("FBLogger")("fts_worker").mustfix("Fail to fetch a new batch of messages with error %s",a==null?void 0:a.message);f==null?void 0:f.endFailure((n=a==null?void 0:a.message)!=null?n:"unknown");await o(a);continue}await o()}};a.getInstance=function(){var b=a.instance;if(b!=null)return b;b=new a();a.instance=b;return b};a.getMediaInstance=function(){var b=a.mediaInstance;if(b!=null)return b;b=new a("media");a.mediaInstance=b;return b};a.resetInstance=function(){a.instance=null};e.setKeepWhileLoop_FOR_TESTING_ONLY=function(a){this.$2=a};function a(a){a===void 0&&(a="search"),this.$1=!1,this.$2=!0,this.$3=!1,this.$4=!0,this.$5=void 0,this.$6={},this.$7=new Set(),this.$8=new Set(),this.$9=new Set(),this.$10=a,c("FBLogger")("fts_worker").info("New MAWFTSRestoreSync instance: "+a)}return a}();q.instance=null;q.mediaInstance=null;function a(){return q.getInstance()}function e(){return q.getMediaInstance()}g.MAWGalleryEventEmitter=j;g.MAWFTSRestoreSync=q;g.getFTSRestoreSync=a;g.getMediaRestoreSync=e}),98);
__d("MAWRestoreMessagesFromEncryptedBackupsNOP",["EBLogger","ExecutionEnvironment","I64","LSDataTraceCheckPoint","LSIntEnum","LSMEBTaskCreationSource","MAWAsyncEBPendingQueryPromise","MAWBridgeTraceRecordCheckpointHandler","MAWBridgeUpdateClientRestoreStatus","MAWChatJid","MAWEBRestoreTrackingUtils","MAWEncryptedBackupsUpdateGlobalRestoreStatus","MAWJobDefinitions","MAWJobManager","MAWMediaGalleryM2Utils","MAWOfflineQueueStatus","MAWTimedJob","MAWUpdateClientRestoreStatusOperationType","ReQL","WAJobOrchestratorTypes","WATagsLogger","cr:4992","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to restore messages for thread "," with error: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Calling worker job for thread "," StartSortKey: "," messagesCount: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Calling prefetch for thread ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to get thread key for "," when calling restoreMessagesFromEncryptedBackup"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][","] Received echo documents for thread: "," startSortKey: "," messagesCount: ",""]);o=function(){return a};return a}async function p(a,b){try{b=await d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(a,(i||(i=d("I64"))).of_string(b));if(b!=null){a=await d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.messages_ranges_v2__generated).getKeyRange(b));if(a!=null)return a.minMessageId}}catch(a){return Promise.reject(a)}return}function q(a,b,c){if(b===0)return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.mi_act_mapping_table)).then(function(a){a.forEach(function(a){a=d("MAWJobDefinitions").toThreadJidPrimaryId((i||(i=d("I64"))).to_string(a.jid));d("MAWEncryptedBackupsUpdateGlobalRestoreStatus").addThreadIdToStatusArray(a,"restore");c&&d("MAWEncryptedBackupsUpdateGlobalRestoreStatus").addThreadIdToStatusArray(a,"ebprefetch")})})}async function a(a,e,f,g,h,s,t,u,v,w,x,y,z,A,B){A===void 0&&(A=d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION);d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(B=w)!=null?B:""]).LOG(o(),(B=w)!=null?B:"",f,x,g.length);B=await d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(a,(i||(i=d("I64"))).of_string(f));B==null&&d("EBLogger").EBLogger.MUSTFIX(n(),f);B=!d("MAWOfflineQueueStatus").isOfflineQueueComplete()&&b("cr:4992")!=null&&x==null&&f!=null;var C=d("MAWEncryptedBackupsUpdateGlobalRestoreStatus").getCurrentGlobalRestoreStatusArrayLength("restore");await q(a,C,B);try{C=await p(a,f);if(B&&b("cr:4992")!=null){d("WATagsLogger").TAGS(["labyrinth_web","eb_prefetch",(B=w)!=null?B:""]).LOG(m(),f);d("MAWEBRestoreTrackingUtils").markEBRestoreFrontloaded(y,w);B={action:d("MAWUpdateClientRestoreStatusOperationType").upsertClientRestoreStatus,threadId:f};await d("MAWBridgeUpdateClientRestoreStatus").call(a,B);await b("cr:4992")(a,e,f,g,h,s,t,u,v,w,x,C,y,z,A)}else{d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(B=w)!=null?B:""]).LOG(l(),f,x,g.length);return r(e,f,g,C,h,t,v,w,x,y,z,A).then(function(){w!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"native_op_end",traceId:w})})}}catch(b){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(s=w)!=null?s:""]).ERROR(k(),f,b);return w!=null?d("MAWBridgeTraceRecordCheckpointHandler").call(a,{checkPointId:(j||(j=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").FLOW_END_FOR_FAILURE),dataTraceId:w,errorMessage:b,shouldFlush:!0,syncChannel:-1,tags:void 0}).then(function(){return Promise.reject(b)}):Promise.reject(b)}}function r(a,b,e,f,g,i,j,k,l,m,n,o){var p=(h||(h=c("ExecutionEnvironment"))).isInWorker?d("MAWJobManager").getJobManager():d("MAWTimedJob").TimedUIJobStarters;if(k!=null&&m===c("LSMEBTaskCreationSource").MESSENGER_MESSAGE_LIST_PAGINATION){var q;return p.waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.restoreMessagesFromEncryptedBackups(a,b,e,g,i,j,(q=f)!=null?q:void 0,(q=k)!=null?q:void 0,(q=l)!=null?q:void 0,void 0,void 0,m,{priority:o},n)).then(function(a){if(a.success===!0)d("MAWAsyncEBPendingQueryPromise").resolvePendingQueryUponReStore(k);else{var b;d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(k,(b=a.payload)!=null?b:c("err")(a.error))}})}if(m===c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE&&d("MAWMediaGalleryM2Utils").shouldSkipSyncToLSDB()){return p.waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.restoreMessagesFromEncryptedBackups(a,b,e,g,i,j,(q=f)!=null?q:void 0,(o=k)!=null?o:void 0,(q=l)!=null?q:void 0,void 0,void 0,m,{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION},n)).then(function(){return Promise.resolve()})}return Promise.resolve(p.fireAndForget(d("MAWJobDefinitions").jobSerializers.restoreMessagesFromEncryptedBackups(a,b,e,g,i,j,(o=f)!=null?o:void 0,(q=k)!=null?q:void 0,(p=l)!=null?p:void 0,void 0,void 0,m,{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION},n)))}g.call=a}),98);